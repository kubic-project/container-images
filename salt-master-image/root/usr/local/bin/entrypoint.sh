#!/bin/bash

ERROR=
NOFILE_LIMIT=${NOFILE_LIMIT:-20000}

if [ -z "$SALTAPI_PASSWORD" ] && [ -z "$SALTAPI_PASSWORD_FILE" ]; then
  echo >&2 "You need to provide SALTAPI_PASSWORD or SALTAPI_PASSWORD_FILE"
  ERROR=1
fi

if [ -z "$VELUM_INTERNAL_API_USERNAME" ] && [ -z "$VELUM_INTERNAL_API_USERNAME_FILE" ]; then
  echo >&2 "You need to provide VELUM_INTERNAL_API_USERNAME or VELUM_INTERNAL_API_USERNAME_FILE"
  ERROR=1
fi

if [ -z "$VELUM_INTERNAL_API_PASSWORD" ] && [ -z "$VELUM_INTERNAL_API_PASSWORD_FILE" ]; then
  echo >&2 "You need to provide VELUM_INTERNAL_API_PASSWORD or VELUM_INTERNAL_API_PASSWORD_FILE"
  ERROR=1
fi

[ -n "$ERROR" ] && exit 1

if [ -n "$SALTAPI_PASSWORD_FILE" ] && [ -f "$SALTAPI_PASSWORD_FILE" ]; then
  SALTAPI_PASSWORD=`cat "$SALTAPI_PASSWORD_FILE"`
fi

if [ -n "$VELUM_INTERNAL_API_USERNAME_FILE" ] && [ -f "$VELUM_INTERNAL_API_USERNAME_FILE" ]; then
  export VELUM_INTERNAL_API_USERNAME=`cat "$VELUM_INTERNAL_API_USERNAME_FILE"`
fi

if [ -n "$VELUM_INTERNAL_API_PASSWORD_FILE" ] && [ -f "$VELUM_INTERNAL_API_PASSWORD_FILE" ]; then
  export VELUM_INTERNAL_API_PASSWORD=`cat "$VELUM_INTERNAL_API_PASSWORD_FILE"`
fi

echo "saltapi:$SALTAPI_PASSWORD" | chpasswd

# Set lower number of max open fd per process. Required to fix bsc#1074836
ulimit -n ${NOFILE_LIMIT}

exec "$@"
